#!/bin/sh
# TortoiseSVN killer...
# Use "svn cat" to retreve related files, then employ dirdiff as diff utility.

PROGNAME=`basename $0`

if [ $# -lt 1 ]; then
    echo "Usage: $PROGNAME REVISION"
    exit;
fi

cur_revision="r"${1/r/}
pre_revision="r"$((${1/r/}-1))
[ -d "/dev/shm" ] && tmpdir="/dev/shm" || tmpdir="/tmp" 
cur_tmpdir="${tmpdir}/${cur_revision}"
pre_tmpdir="${tmpdir}/${pre_revision}"

repo_root=`svn info | grep "^Repository Root:" | sed -e "s/^Repository Root: //"`
filelist=`svn log -v -r${cur_revision} ${repo_root} | grep "^   [A|M|D]" | awk '{print $2}'`

mkdir ${cur_tmpdir} ${pre_tmpdir}
for filepath in ${filelist}; do
	#echo $repo_root/$filepath
	svn cat -r ${cur_revision} ${repo_root}/${filepath} > ${cur_tmpdir}/`basename $filepath` 2> /dev/null 
	svn cat -r ${pre_revision} ${repo_root}/${filepath} > ${pre_tmpdir}/`basename $filepath` 2> /dev/null
done

# Remove empty file generated by "svn cat" a non-exist file[@REV] or a directory.
find ${cur_tmpdir} ${pre_tmpdir} -type f -size 0 -exec rm -rf '{}' \;

dirdiff ${cur_tmpdir} ${pre_tmpdir}

trap "rm -rf ${cur_tmpdir} ${pre_tmpdir}" 0 1 2 15

rm -rf ${cur_tmpdir} ${pre_tmpdir}
