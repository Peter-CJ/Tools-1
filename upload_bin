#!/bin/sh

if [ $# -lt 2 ]; then
	echo "Usage: $0 <DEVICE_IP> <FW_BIN>"
	exit 0
fi

DEVICE_IP="$1"
FW_BIN="$2"

if [ "$FW_BIN" = "-" ]; then
	. ubnt-devel-aircam
	FW_BIN=$(ls "$IMAGEDIR"/*[^bootloader].bin)
fi

echo Firmware name: "$(basename "$FW_BIN")"

KEY="$HOME/.ssh/id_rsa_ubnt"
if [ ! -e "$KEY" ]; then
	ssh-keygen -t rsa -N "" -f "$KEY"
fi

SSH_OPTION_IGNORE_CHECK="-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

sshpass -p ubnt ssh-copy-id $SSH_OPTION_IGNORE_CHECK -i "$KEY".pub ubnt@"$DEVICE_IP" >/dev/null 2>&1
scp $SSH_OPTION_IGNORE_CHECK -i "$KEY" "$FW_BIN" ubnt@"$DEVICE_IP":/tmp/fwupdate.bin
[ $? -eq 0 ] && ssh $SSH_OPTION_IGNORE_CHECK -i "$KEY" ubnt@"$DEVICE_IP" /usr/bin/fwupdate -m || echo "FW upload fail!"
